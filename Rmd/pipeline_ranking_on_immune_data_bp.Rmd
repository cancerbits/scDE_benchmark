---
title: 'Pipeline ranking on immune data with blueprint as truth'
author: 'Christoph Hafemeister'
date: '`r format(Sys.time(), "%B %d, %Y %H:%M:%S %Z")`'
output:
  html_document: 
    toc: yes
    toc_float: yes
    code_folding: hide
    highlight: pygments
    df_print: paged
---

# Setup

```{r}
source("R/setup.R")
source('R/utilities.R')

library('dplyr')
library('ComplexHeatmap')
library('ggplot2')

BP_DIR <- file.path(config$out_root, 'results', 'immune_data_blueprint')
RES_DIR <- file.path(config$out_root, 'results', 'immune_data')
FIG_DIR <- file.path(config$out_root, 'figures')
FIG_SUPP_DIR <- file.path(config$out_root, 'figures', 'supp')
dir.create(path = FIG_SUPP_DIR, showWarnings = FALSE, recursive = TRUE)
```

# Main

## Load the bulk data results

```{r}
bp_res <- readRDS(file = file.path(BP_DIR, 'blueprint_immune_comparisons.Rds'))
bp_res_names <- sapply(bp_res, function(x) paste(x$comp[1], x$comp[2], sep = '_vs_'))
names(bp_res) <- bp_res_names
print(bp_res_names)
```


## Process the pipeline results

We do this per comparison
```{r}
comps <- list.files(path = RES_DIR, full.names = FALSE) %>%
  stringr::str_extract(pattern = '^[^-]+') %>%
  unique()
print(comps)
```

```{r}
res_list <- list()
for (comp in comps) {
  message(comp)
  
  # extract the celltypes being compared; 
  # also fix the comparison order as used in the blueprint comparisons
  comp_types <- stringr::str_split(string = comp, pattern = '_vs_')[[1]] 
  comp_ordered <- paste(sort(comp_types), collapse = '_vs_')
  
  # get the blueprint results
  bp_de_res <- bp_res[[comp_ordered]]$de_res
  
  # run GSEA per DE pipeline
  rds_files <- list.files(path = RES_DIR, pattern = paste0('^', comp, '.*\\.Rds$'), full.names = TRUE)
  
  comp_res <- lapply(rds_files, function(f) {
    # for testing: f <- "/home/rstudio/mnt_out/results/immune_data/MONOCYTES_vs_B_CELLS-counts-edger_qlf_7pr.Rds"
    #f <- "/home/rstudio/mnt_out/results/immune_data/MONOCYTES_vs_B_CELLS-counts-edger_qlf_7pr.Rds"
    #f <- "/home/rstudio/mnt_out/results/immune_data/MONOCYTES_vs_B_CELLS-sum1-mast.Rds"
    #f <- "/home/rstudio/mnt_out/results/immune_data/MONOCYTES_vs_B_CELLS-counts-qlrt_7pr.Rds"
    #f <- "/home/rstudio/mnt_out/results/immune_data/T_CELLS_vs_MONOCYTES-counts-limma_voom_7pr.Rds"
    res <- readRDS(f)
    de_res <- res$res %>% 
      mutate(pval = case_when(is.na(pval) ~ 1, TRUE ~ pval),
             FDR = p.adjust(pval, method = 'fdr'),
             pred_de = FDR < 0.05,
             pred_de3 = factor(effect_direction * (FDR < 0.05), levels = c(-1, 0, 1)))
    
    de_res <- left_join(de_res, bp_de_res, by = c('feature' = 'symbol')) %>%
      filter(!is.na(grp1), !is.na(grp2)) # filter out NA in grp1, grp2 (non-matching gene names)?
    #table(de_res$pred_de3, de_res$grp1 == 0, useNA = 'always')
    #table(de_res$pred_de3, de_res$grp2 == 0, useNA = 'always')
    #table(de_res$pred_de3, de_res$grp1 == 1, useNA = 'always')
    #table(de_res$pred_de3, de_res$grp2 == 1, useNA = 'always')
    
    # proxy for precision: fraction of DE genes that is in core bulk DE set
    # proxy for sensitivity: fraction of core bulk DE set that is DE
    if (comp_ordered != comp) {
      de_res <- mutate(de_res, bulk_de3 = grp1 - grp2)
    } else {
      de_res <- mutate(de_res, bulk_de3 = grp2 - grp1)
    }
    
    # metrics for core DE
    tmp <- mutate(de_res, bulk_de3 = case_when(bulk_de3 < 1 & bulk_de3 > -1 ~ 0, TRUE ~ bulk_de3)) 
    
    bind_cols(
      tidyr::pivot_wider(res$timing, names_from = step, values_from = c(name, time)),
      summarise(tmp, perf_metrics(pred_de3, bulk_de3)) 
      # summarise(de_res, 
      #           n = n(), n_pred_de = sum(pred_de3 != 0), 
      #           n_bulk_all = sum(bulk_de3 %in% c(-1, 1)),
      #           n_bulk_any = sum(bulk_de3 != 0),
      #           prec = (sum(pred_de3 == -1 & bulk_de3 == -1) + sum(pred_de3 == 1 & bulk_de3 == 1)) / n_pred_de,
      #           relevance = (sum(pred_de3 == -1 & bulk_de3 < 0) + sum(pred_de3 == 1 & bulk_de3 > 0)) / n_pred_de,
      #           sens = (sum(pred_de3 == -1 & bulk_de3 == -1) + sum(pred_de3 == 1 & bulk_de3 == 1)) / n_bulk_all,
      #           recovery = (sum(pred_de3 == -1 & bulk_de3 < 0) + sum(pred_de3 == 1 & bulk_de3 > 0)) / n_bulk_any)
    ) %>%
      mutate(comparison = comp)
  }) %>% bind_rows()
  
  res_list[[comp]] <- comp_res
}
sum_res <- bind_rows(res_list) %>%
  dplyr::rename(transformation = name_transformation, 
                de_method = name_de_method) %>%
  mutate(time = time_transformation + time_de_method,
         pipeline = paste(transformation, de_method, sep = '-'),
         F1 = 2 * (Precision * Sensitivity) / (Precision + Sensitivity))
```

## Show distribution of scores

```{r}
ggplot(sum_res, aes(Precision)) +
  geom_histogram(binwidth = 0.02) +
  facet_wrap(~ comparison)

ggplot(sum_res, aes(Sensitivity)) +
  geom_histogram(binwidth = 0.02) +
  facet_wrap(~ comparison)

ggplot(sum_res, aes(GSS)) +
  geom_histogram(binwidth = 0.01) +
  facet_wrap(~ comparison)

ggplot(sum_res, aes(F1)) +
  geom_histogram(binwidth = 0.01) +
  facet_wrap(~ comparison)

ggplot(sum_res, aes(PSS)) +
  geom_histogram(binwidth = 0.01) +
  facet_wrap(~ comparison)

ggplot(sum_res, aes(OR)) +
  geom_histogram(binwidth = 0.01) +
  facet_wrap(~ comparison)

ggplot(sum_res, aes(ORSS)) +
  geom_histogram(binwidth = 0.01) +
  facet_wrap(~ comparison)
```

```{r}
ggplot(sum_res, aes(Sensitivity, Precision, color = comparison)) +
  geom_point()
ggplot(sum_res, aes(Sensitivity, Precision, color = cut(GSS, 11))) +
  geom_point() +
  facet_wrap(~ comparison) +
  theme_dark() +
  scale_color_viridis_d() 

ggplot(sum_res, aes(Sensitivity, Precision, color = cut(F1, 11))) +
  geom_point() +
  facet_wrap(~ comparison) +
  theme_dark() +
  scale_color_viridis_d() 

ggplot(sum_res, aes(Sensitivity, Precision, color = cut(PSS, 11))) +
  geom_point() +
  facet_wrap(~ comparison) +
  theme_dark() +
  scale_color_viridis_d() 

ggplot(sum_res, aes(Sensitivity, Precision, color = cut(OR, 11))) +
  geom_point() +
  facet_wrap(~ comparison) +
  theme_dark() +
  scale_color_viridis_d() 

ggplot(sum_res, aes(Sensitivity, Precision, color = cut(ORSS, 11))) +
  geom_point() +
  facet_wrap(~ comparison) +
  theme_dark() +
  scale_color_viridis_d() 
```

Re-scale the metrics to go from 0 to 1 per comparison
```{r}
sum_res <- group_by(sum_res, comparison) %>%
  mutate(Precision_rel = scales::rescale(Precision),
         Sensitivity_rel = scales::rescale(Sensitivity),
         GSS_rescaled = scales::rescale(scales::oob_squish_any(GSS)))
ggplot(sum_res, aes(Sensitivity_rel, Precision_rel, color = comparison)) +
  geom_point()
ggplot(sum_res, aes(Sensitivity, Precision, color = GSS_rescaled)) +
  geom_point() +
  facet_wrap(~ comparison, scales = 'free') +
  theme_dark() +
  scale_color_viridis_c() 
```


## Summarize the summarized results

GSS ranking
```{r}
fr <- group_by(sum_res, transformation, de_method, pipeline) %>%
  summarise(score = mean(GSS), time = sum(time)) %>%
  #summarise(score = mean(relevance) + mean(recovery), time = sum(time)) %>%
  ungroup() %>%
  arrange(-score)
fr
```

rel GSS ranking
```{r}
fr <- group_by(sum_res, transformation, de_method, pipeline) %>%
  summarise(score = mean(GSS_rescaled), time = sum(time)) %>%
  #summarise(score = mean(relevance) + mean(recovery), time = sum(time)) %>%
  ungroup() %>%
  arrange(-score)
fr
```


Use mean rescaled GSS as final score
```{r}
fr <- group_by(sum_res, transformation, de_method, pipeline) %>%
  summarise(score = mean(GSS_rescaled), time = sum(time)) %>%
  ungroup() %>%
  arrange(-score)
fr %>% select(transformation, de_method, score, time)
```

## Create heatmaps

Get data into wide format
```{r}
metrics_wide <- arrange(sum_res, comp) %>%
                  tidyr::pivot_wider(
                              id_cols = c(pipeline, transformation, de_method),
                              names_from = c(comparison, comparison), 
                              values_from = c(Precision, Sensitivity)) %>%
  select(-transformation, -de_method) 
```

Save final ranking 
```{r}
saveRDS(list(fr = fr, metrics_wide = metrics_wide), 
        file = file.path(config$out_root, 'results', 'final_ranking_immune.Rds'))
```


Define the main plotting function
```{r}
library('ComplexHeatmap')
res_heatmap <- function(fr, metrics_wide, idx = 1:nrow(fr), do_rescale = TRUE,
                        filename = NULL, fig_width = 7, fig_height = 32, 
                        show_values = TRUE) {
  fr <- fr[idx, ]
  
  mat <- as.matrix(left_join(fr, metrics_wide, by = 'pipeline') %>%
                   select(starts_with(c("Prec", "Sens"))))
  rownames(mat) <- as.character(fr$pipeline)
  colnames(mat) <- stringr::str_remove(colnames(mat), '^Precision_|^Sensitivity_')
  colnames(mat) <- stringr::str_replace_all(colnames(mat), pattern = '_', replacement = ' ')
  colnames(mat) <- gsub("(^|[[:space:]])([[:alpha:]])", "\\1\\U\\2", colnames(mat), perl=TRUE)
  colnames(mat) <- stringr::str_replace_all(colnames(mat), pattern = 'Vs', replacement = 'vs')
  
  # create a scaled version for the colors
  if (do_rescale) {
    mat_rescaled <- apply(mat, 2, scales::rescale)
    heatmap_legend_param <- list(
            title = 'Column-\nrescaled\nvalue', at = c(0, 1), 
            labels = c("Worst", "Best"), border = FALSE)
  } else {
    mat_rescaled <- mat
    heatmap_legend_param <- list(title = 'Value')
  }
  
  
  # create a function print the values in each heatmap cell
  cell_fun = function(j, i, x, y, width, height, fill) {
            grid.text(sprintf("%2.0f", mat[i, j]*100), x, y, 
                      gp = gpar(fontsize = 8, 
                                col = c('white', 'black')[(mat_rescaled[i, j] > 0.4) + 1]))
  }
  if (!show_values) {
    cell_fun = NULL
  }
  
  ta = HeatmapAnnotation(foo = anno_block(
    gp = gpar(fill = 'gray'),
    labels = c("Precision", "Sensitivity"), 
    labels_gp = gpar(col = "black", fontsize = 10)))
  
  anno_right <- rowAnnotation(
    GSS = anno_barplot(scales::oob_squish_any(fr$score), bar_width = 1),
    #F1 = anno_barplot(fr$F1, bar_width = 1),
    #FDR_low = anno_barplot(fr$FDR_low, bar_width = 1),
    #FDR_high = anno_barplot(fr$FDR_high, bar_width = 1),
    Time = anno_barplot(fr$time, bar_width = 1),
    annotation_name_rot = 0,
    annotation_name_side = 'top')
  
  anno_left <- rowAnnotation(
    Transformation = anno_text(fr$transformation, 
                               just = "left", show_name = TRUE, 
                               width = unit(25, 'mm'), 
                               gp = gpar(fontsize = 11)),
    `DE method` = anno_text(fr$de_method, 
                           just = "left", show_name = TRUE,
                           gp = gpar(fontsize = 11)), 
    PB = grepl(pattern = '\\dpr', fr$de_method),
    col = list(PB = c("FALSE" = "white", "TRUE" = "black")),
    gap = unit(10, "points"),
    annotation_name_rot = 0,
    annotation_name_align = TRUE,
    annotation_name_side = 'top',
    show_legend = FALSE)
  
  
  ch <- Heatmap(mat_rescaled, cluster_columns = FALSE, cluster_rows = FALSE,
          show_row_names = FALSE, show_column_names = TRUE, column_names_rot = 45,
          col = hcl.colors(n = 21, palette = 'viridis'),
          name = 'Value', column_title = NULL,
          column_split = rep(c("A", "B"), each = ncol(mat)/2),
          top_annotation = ta, right_annotation = anno_right,
          left_annotation = anno_left,
          cell_fun = cell_fun,
          heatmap_legend_param = heatmap_legend_param)
  
  if (!is.null(filename)) {
    cairo_pdf(filename = filename, width = fig_width, height = fig_height)
    show(ch)
    dev.off()
  }
  return(ch)
}
```

Big heatmap
```{r}
ch <- res_heatmap(fr, metrics_wide, 
                  filename = file.path(FIG_DIR, 'ranking_immune_data_bp_big.pdf'), 
                  fig_width = 7, fig_height = 42)
```
```{r}
ch <- res_heatmap(fr, metrics_wide, 
                  filename = file.path(FIG_DIR, 'ranking_immune_data_bp_big_squished.pdf'), 
                  fig_width = 7, fig_height = 6, show_values = FALSE)
```

PB vs non-PB
```{r}
pb = grepl(pattern = '\\dpr+', fr$de_method)
ch <- res_heatmap(fr, metrics_wide, idx = which(pb),
                  filename = file.path(FIG_DIR, 'ranking_immune_data_bp_big_pb.pdf'), 
                  fig_width = 6, fig_height = 16)
ch <- res_heatmap(fr, metrics_wide, idx = which(!pb),
                  filename = file.path(FIG_DIR, 'ranking_immune_data_bp_big_sc.pdf'), 
                  fig_width = 6, fig_height = 22)
```

Create reduced heatmaps

```{r}
fr$de_method_grp1 = stringr::str_remove_all(string = fr$de_method, pattern = '\\d+(?=pr)')
table(fr$de_method_grp1)

idx <- mutate(fr, idx = 1:nrow(fr)) %>%
  group_by(de_method_grp1) %>%
  slice_min(order_by = idx) %>%
  pull(idx) %>% sort()

ch <- res_heatmap(fr, metrics_wide, idx = idx,
                  filename = file.path(FIG_DIR, 'ranking_immune_data_bp_filter1.pdf'), 
                  fig_width = 7, fig_height = 6)

fr <- mutate(fr, de_method_grp2 = stringr::str_remove_all(string = de_method_grp1, pattern = '_(lrt|wald|exact|qlf|trend|voom)$'))
fr <- mutate(fr, de_method_grp2 = stringr::str_remove_all(string = de_method_grp2, pattern = '_(ns|pc|dc|pf|10k|gm)'))
table(fr$de_method_grp2)

idx <- mutate(fr, idx = 1:nrow(fr)) %>%
  group_by(de_method_grp2) %>%
  slice_min(order_by = idx) %>%
  pull(idx) %>% sort()

ch <- res_heatmap(fr, metrics_wide, idx = idx,
                  filename = file.path(FIG_DIR, 'ranking_immune_data_bp_filter2.pdf'), 
                  fig_width = 7, fig_height = 4)
```


# Appendix

Runtime: `r time_diff(SETUP_TIME)`

Session Info
```{r}
sessionInfo()
```

Future plan
```{r}
future::plan()
```

More session info
```{r}
devtools::session_info()
```
