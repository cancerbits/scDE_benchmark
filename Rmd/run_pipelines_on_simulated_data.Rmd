---
title: 'Run pipelines on simulated data'
author: 'Christoph Hafemeister'
date: '`r format(Sys.time(), "%B %d, %Y %H:%M:%S %Z")`'
output:
  html_document: 
    toc: yes
    toc_float: yes
    code_folding: hide
    highlight: pygments
    df_print: paged
---

# Setup

```{r}
source("R/setup.R")
source('R/utilities.R')
source('R/transformations.R')
source('R/de_methods.R')
library('dplyr')
library('future.apply')

DATA_DIR <- file.path(config$out_root, 'simulated_data')
REPLICATES <- 13
OUT_DIR <- file.path(config$out_root, 'results', 'simulated_data')
dir.create(path = OUT_DIR, showWarnings = FALSE, recursive = TRUE)
SEED_TRANS <- 783838
SEED_DE <- 184920
```

# Main

Read the pipeline definition files

```{r}
pipelines <- load_pipelines(config)
```


List data files
```{r}
data_files <- list.files(path = DATA_DIR, full.names = TRUE)
```


Go over the files, create list of jobs and run them
```{r}
for (f in data_files) {
  data_name <- gsub(pattern = 'sim_data_', replacement = '', x = basename(f))
  data_name <- gsub(pattern = '\\.Rds$', replacement = '', x = data_name)
  message('simulation experiment ', data_name)
  
  data_lst <- readRDS(f)
  
  jobs <- full_join(
    full_join(data.frame(data_name = data_name), data.frame(replicate = 1:length(data_lst)), by = character()),
    pipelines,
    by = character()
  )
  message('\tnumber of jobs: ', nrow(jobs))
  
  # check which output files already exist
  jobs <- mutate(jobs, 
                 out_file = file.path(OUT_DIR, sprintf('%s-%02d-%s-%s.Rds', data_name, replicate, name.trans, name.de)),
                 out_file_exists = file.exists(out_file))
  message(sprintf('\toutput files of %d jobs already exist - skip them', sum(jobs$out_file_exists)))
  jobs <- filter(jobs, !out_file_exists)
  if (nrow(jobs) < 1) {
    next
  }
  
  return_values <- future_sapply(X = 1:nrow(jobs), FUN = function(i) {
    replicate_n <- jobs$replicate[i]
    transformation <- jobs$name.trans[i]
    name.de <- jobs$name.de[i]
    out_file <- jobs$out_file[i]
    
    message(basename(out_file))
    res <- run_pipeline(input_data = data_lst[[jobs[i, 'replicate']]], 
                         transformation = jobs[i, 'name.trans'], 
                         de_method = jobs[i, 'de method'], 
                         test_type = jobs[i, 'test type'], 
                         size_factor_method = jobs[i, 'size factor methods.de'], 
                         G = jobs[i, 'pseudo replicates'], 
                         aggregation_strategy = jobs[i, 'aggregation strategy'],
                         seed_trans = SEED_TRANS, seed_de = SEED_DE)
    res$job_pars <- jobs[i, ]
    saveRDS(object = res, file = out_file)
    return('done')
    
  }, future.seed=NULL)
  print(table(return_values))
}
```


# Appendix

Runtime: `r time_diff(SETUP_TIME)`

Session Info
```{r}
sessionInfo()
```

Future plan
```{r}
future::plan()
```

More session info
```{r}
devtools::session_info()
```
